# 几种抗性数据库分析比较

### Package:
blast 2.6.0
blastn: 2.6.0+
* I did not use ab-blastn for the reason that I couldn't have the output format contain query_len and subject_len. But the blastn package 2.6 could modify the output parameters(query_len and subject_len) which was more convenient for filter. 

### My standards of making sure that genome sequences of DNA are the same in two databases
1. query_len - sub_len = 0
2. query_len - align_len = 0
3. sub_len - align_len = 0
4. % identity = 100
5. Opposite strands are considered the same if meets with the above standards.

### Results
1. resfinder db: 0/3097(All the sequences in resfinder db exist in Megares db)
2. arg_annot db: 40/2038(there are 40 genome sequences of DNA in the arg_annot db not existed in the megares db)
3. CARD db: 47/2892(there are 47 genome sequences of DNA in the CARD db not existed in the megares db)
4. There are 7868 sequences in Megares db(version 2.0.0) in all



### My Protocol
1. Download the databases
MEGARes: version 2.0.0(release on 2019-10-14) 
CARD：version 3.0.7(release on 2019-10-23)
ARG-ANNOT: May 2018 release version(ARG-ANNOT has no official website so I use the backup link to download the dataset. Details:https://github.com/tseemann/abricate/issues/79)
ResFinder database: (2019-10-01) version 3.2
2. Unix: Make megares db into blast database
```
makeblastdb -in /home/bit150-27/test/megares_database/megares_database_v1.01.fasta -dbtype nucl -out /home/bit150-27/test/megares_database/megaresdatabase
```
3. Unix: Use blastn for query fasta file and megares database
* Here, I use arg-annot-v4-nt-may2018_doc.fasta for example.
```
#!/bin/bash
module load bio
 blastn  \
   -db /home/bit150-27/test/megares_database/megaresdatabase \
   -query /home/bit150-27/test/arg-annot-v4-nt-may2018_doc.fasta \
   -out /home/bit150-27/test/argannot_blast_table.csv \
   -outfmt "7 qseqid qgi qaccver sseqid sgi saccver pident length mismatch gapopen qstart qend sstart send evalue bitscore qlen slen"
```
4. Do some modifications of the output csv
* Make the column splited by tab
* Delete the rows begin with # or rows that contain empty cells)
```
import numpy as np 
import pandas as pd 
import re 
data=pd.read_csv("/Users/xinmingxu/Downloads/card_blast_table.csv")

#subjectdata=pd.read_csv("")
data=data.dropna() 
data.to_csv('/Users/xinmingxu/Downloads/card_blast_table_dropna.csv')
```

5. Do iterations to extract all the sequence ID in the database since we have the sequence identifier '>'
```
f=open('/Users/xinmingxu/korf_lab/megares_v1.01/megares_database_v1.01.fasta','r')
lines=f.readlines()
for i in lines:
    if '>' in i:
        i=str(i).strip('\n') 
        i=str(i).strip('>') 
        i.split()
        print(i)
```
6. Open the final output and do filter jobs by excel
* Add columns:
    * query_len - sub_len;
    * query_len - align_len; 
    * sub_len - align_len
* Filter the above three columns and select the values in the three columns all equal to 0 and % identity = 100
7. Use R to check out whether the sequences in ResFinder/Arg-annot/CARD db existed in the megares db.
```
library(readr)
library(dplyr)
library(tidyr)
Argannot_blast_processed <- read_excel("Argannot_blast_processed.xlsx")
CARD_blast_processed <- read_excel("CARD_blast_processed.xlsx")
Resfinder_blast_processed <- read_excel("Resfinder_blast_processed.xlsx")
Megares_combined_data <- read_excel("Megares_combined_data.xlsx")
CARD_data <- read_excel("CARD_data.xlsx")
Argannot_data <- read_excel("Argannot_data.xlsx")
Resfinder_data <- read_excel("Resfinder_data.xlsx")

colnames(Argannot_blast_processed)[4] = 'Sub_ID'
colnames(CARD_blast_processed)[4] = 'Sub_ID'
colnames(Resfinder_blast_processed)[4] = 'Sub_ID'

colnames(Argannot_blast_processed)[1] = 'Query_ID'
colnames(CARD_blast_processed)[1] = 'Query_ID'
colnames(Resfinder_blast_processed)[1] = 'Query_ID'
#extract sequences in CARD but not in Megares---------------------------------------------------
test1_card_megares_blastresult <- CARD_blast_processed
test1_card_megares_blastresult = mutate(test1_card_megares_blastresult, samequeryID="Query_ID" )
test_missing_value_in_card <- left_join(CARD_data,test1_card_megares_blastresult,by=c('SID'='Query_ID'))
test_na_card <- filter(test_missing_value_in_card, is.na(samequeryID))
card=select(test_na_card,SID)
write.csv(card,'CARD.csv')

#extract sequences in Argannot but not in Megares-----------------------------------------------
test1_argannot_megares_blastresult <- Argannot_blast_processed
test1_argannot_megares_blastresult = mutate(test1_argannot_megares_blastresult, samequeryID="Query_ID" )
test_missing_value_in_argannot <- left_join(Argannot_data,test1_argannot_megares_blastresult,by=c('SID'='Query_ID'))
test_na_argannot <- filter(test_missing_value_in_argannot, is.na(samequeryID))
Argannot=select(test_na_argannot,SID)
write.csv(Argannot,'Argannot.csv')

#extract sequences in Resfinder but not in Megares----------------------------------------------
test1_resf_megares_blastresult <- Resfinder_blast_processed
test1_resf_megares_blastresult = mutate(test1_resf_megares_blastresult, samequeryID="Query_ID" )
test_missing_value_in_resf <- left_join(Resfinder_data,test1_resf_megares_blastresult,by=c('SID'='Query_ID'))
test_na_resf <- filter(test_missing_value_in_resf, is.na(samequeryID))
resfinder=select(test_na_resf,SID)
write.csv(resfinder,'Resfinder.csv')
```
8.Export files